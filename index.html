<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>打字雨 Typing Rain</title>
  <style>
    html, body { height: 100%; margin: 0; background:#0b1020; color:#e8ecff; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Microsoft YaHei", Arial; }
    #wrap { display:flex; flex-direction:column; height:100%; }
    header {
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px; border-bottom:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
    }
    .left { display:flex; gap:10px; align-items:center; }
    .pill {
      padding:6px 10px; border:1px solid rgba(255,255,255,.12);
      border-radius:999px; background:rgba(255,255,255,.06);
      font-size:13px;
    }
    .btn {
      cursor:pointer; user-select:none;
      padding:8px 12px; border-radius:10px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:#e8ecff; font-weight:600;
    }
    .btn:hover { background:rgba(255,255,255,.12); }
    .btn:active { transform: translateY(1px); }
    main { position:relative; flex:1; overflow:hidden; }
    canvas { width:100%; height:100%; display:block; }
    #overlay {
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background: rgba(0,0,0,.35); backdrop-filter: blur(4px);
    }
    .card {
      width:min(520px, calc(100% - 24px));
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      box-shadow: 0 20px 80px rgba(0,0,0,.35);
      padding:18px;
    }
    .card h1 { margin:0 0 6px; font-size:22px; letter-spacing:.5px; }
    .card p { margin:0 0 12px; opacity:.9; line-height:1.55; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label { font-size:13px; opacity:.9; }
    input[type="range"] { width:180px; }
    kbd {
      padding:2px 6px; border-radius:6px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
    }
    footer {
      padding:10px 16px; border-top:1px solid rgba(255,255,255,.08);
      font-size:12px; opacity:.85;
      display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .warn { color:#ffd1d1; }
  </style>
</head>
<body>
<div id="wrap">
  <header>
    <div class="left">
      <div class="pill">分数：<span id="score">0</span></div>
      <div class="pill">连击：<span id="combo">0</span></div>
      <div class="pill">生命：<span id="life">10</span></div>
      <div class="pill">等级：<span id="level">1</span></div>
    </div>
    <div class="left">
      <button class="btn" id="pauseBtn">暂停</button>
      <button class="btn" id="resetBtn">重开</button>
    </div>
  </header>

  <main>
    <canvas id="c"></canvas>

    <div id="overlay">
      <div class="card">
        <h1>打字雨 Typing Rain</h1>
        <p>
          字母会从天上掉下来，在落地前按下对应字母即可消除并得分。<br/>
          <span class="warn">注意：</span>必须用英文键盘输入（A-Z），不区分大小写。
        </p>

        <div class="row" style="margin:10px 0 6px;">
          <label>难度（掉落速度）：<span id="spdLabel">1.0x</span></label>
          <input id="speed" type="range" min="6" max="20" value="10" />
        </div>
        <div class="row" style="margin:0 0 14px;">
          <label>密度（生成频率）：<span id="rateLabel">中</span></label>
          <input id="rate" type="range" min="200" max="900" value="520" />
        </div>

        <div class="row">
          <button class="btn" id="startBtn">开始</button>
          <span class="pill">快捷键：<kbd>Space</kbd> 暂停 / <kbd>R</kbd> 重开</span>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div>玩法小技巧：优先打“最低”的字母，保持连击会加分。</div>
    <div>Made for you ✨</div>
  </footer>
</div>

<script>
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');

  const overlay = document.getElementById('overlay');
  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const resetBtn = document.getElementById('resetBtn');

  const speedEl = document.getElementById('speed');
  const rateEl = document.getElementById('rate');
  const spdLabel = document.getElementById('spdLabel');
  const rateLabel = document.getElementById('rateLabel');

  const scoreEl = document.getElementById('score');
  const comboEl = document.getElementById('combo');
  const lifeEl  = document.getElementById('life');
  const levelEl = document.getElementById('level');

  let W=0, H=0, DPR=1;

  function resize() {
    DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const rect = canvas.getBoundingClientRect();
    W = Math.floor(rect.width * DPR);
    H = Math.floor(rect.height * DPR);
    canvas.width = W;
    canvas.height = H;
    ctx.setTransform(1,0,0,1,0,0);
  }
  window.addEventListener('resize', resize);

  // Game state
  let running = false;
  let paused = false;
  let over = false;

  let score = 0;
  let combo = 0;
  let life  = 10;
  let level = 1;

  let drops = [];
  let lastSpawn = 0;
  let lastTime = 0;

  // Tunables
  let baseSpeed = 10; // range 6-20 (mapped)
  let spawnEvery = 520; // ms 200-900

  function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  function randLetter(){
    const code = randInt(65, 90); // A-Z
    return String.fromCharCode(code);
  }

  function setLabels(){
    const spd = Number(speedEl.value);
    baseSpeed = spd;
    spdLabel.textContent = (spd/10).toFixed(1) + "x";

    const r = Number(rateEl.value);
    spawnEvery = r;
    let txt = "中";
    if (r < 360) txt = "高";
    else if (r > 700) txt = "低";
    rateLabel.textContent = txt;
  }
  speedEl.addEventListener('input', setLabels);
  rateEl.addEventListener('input', setLabels);

  function syncHUD(){
    scoreEl.textContent = score;
    comboEl.textContent = combo;
    lifeEl.textContent  = life;
    levelEl.textContent = level;
  }

  function resetGame(){
    score = 0; combo = 0; life = 10; level = 1;
    drops = [];
    lastSpawn = 0;
    lastTime = 0;
    over = false;
    paused = false;
    running = false;
    overlay.style.display = 'flex';
    pauseBtn.textContent = '暂停';
    syncHUD();
  }

  function startGame(){
    if (running) return;
    running = true;
    paused = false;
    over = false;
    overlay.style.display = 'none';
    lastTime = performance.now();
    requestAnimationFrame(tick);
  }

  function togglePause(){
    if (!running || over) return;
    paused = !paused;
    pauseBtn.textContent = paused ? '继续' : '暂停';
    if (!paused) {
      lastTime = performance.now();
      requestAnimationFrame(tick);
    }
  }

  function gameOver(){
    over = true;
    running = false;
    overlay.style.display = 'flex';
    overlay.querySelector('h1').textContent = '游戏结束';
    overlay.querySelector('p').innerHTML =
      `最终分数：<b>${score}</b>，最高连击：<b>${combo}</b><br/>点“开始”再来一局。`;
  }

  function maybeLevelUp(){
    // 每 500 分升一级：增加速度、生成更密
    const newLevel = Math.floor(score / 500) + 1;
    if (newLevel !== level) {
      level = newLevel;
    }
  }

  function spawnOne(){
    // 生成：同一时刻可能有重复字母，属于常见“打字雨”体验
    const ch = randLetter();
    const size = randInt(26, 42) * DPR;
    const x = randInt(20, Math.max(20, W - 20));
    const y = -randInt(20, 80) * DPR;
    const speed = ((baseSpeed / 10) * (1 + (level-1)*0.07)) * DPR; // px per frame-ish
    drops.push({ ch, x, y, size, speed, born: performance.now() });
  }

  function handleKey(k){
    if (over) return;
    if (!running) return;
    if (paused) return;

    const ch = (k || '').toUpperCase();
    if (ch.length !== 1 || ch < 'A' || ch > 'Z') return;

    // 找“最靠近地面”的匹配字母（更符合直觉）
    let idx = -1;
    let bestY = -Infinity;
    for (let i=0;i<drops.length;i++){
      if (drops[i].ch === ch && drops[i].y > bestY){
        bestY = drops[i].y;
        idx = i;
      }
    }
    if (idx !== -1){
      const d = drops[idx];
      drops.splice(idx,1);

      combo += 1;
      const gain = Math.floor(10 + combo * 1.5 + level * 2);
      score += gain;
      maybeLevelUp();
      syncHUD();

      // 小爆炸
      burst(d.x, d.y, d.size, true);
    } else {
      // 打空：断连击
      combo = 0;
      syncHUD();
      burst(Math.random()*W, Math.random()*H*0.6, 24*DPR, false);
    }
  }

  window.addEventListener('keydown', (e) => {
    if (e.code === 'Space') { e.preventDefault(); togglePause(); return; }
    if (e.key === 'r' || e.key === 'R') { resetGame(); startGame(); return; }
    handleKey(e.key);
  });

  // 粒子
  let particles = [];
  function burst(x,y,size,good){
    const n = good ? 14 : 8;
    for (let i=0;i<n;i++){
      const a = Math.random()*Math.PI*2;
      const v = (Math.random()*2 + 1) * (good ? 1.8 : 1.2) * DPR;
      particles.push({
        x, y,
        vx: Math.cos(a)*v,
        vy: Math.sin(a)*v,
        life: 400 + Math.random()*200,
        born: performance.now(),
        r: (Math.random()*2 + 1) * DPR,
        good
      });
    }
  }

  function drawBG(t){
    // 星空渐变
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0, 'rgba(18, 28, 62, 1)');
    g.addColorStop(1, 'rgba(9, 12, 26, 1)');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    // 轻微噪点星点
    ctx.globalAlpha = 0.12;
    for (let i=0;i<60;i++){
      const x = (Math.sin((t/800)+i)*0.5+0.5) * W;
      const y = (Math.cos((t/900)+i*1.7)*0.5+0.5) * H;
      ctx.beginPath();
      ctx.arc(x,y, (i%3+1)*DPR, 0, Math.PI*2);
      ctx.fillStyle = 'white';
      ctx.fill();
    }
    ctx.globalAlpha = 1;
  }

  function drawDrops(){
    for (const d of drops){
      // glow
      ctx.save();
      ctx.font = `${d.size}px ui-monospace, Menlo, Consolas, monospace`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';

      ctx.shadowColor = 'rgba(120, 170, 255, .55)';
      ctx.shadowBlur = 18 * DPR;
      ctx.fillStyle = 'rgba(232, 236, 255, .96)';
      ctx.fillText(d.ch, d.x, d.y);

      ctx.restore();
    }
  }

  function drawGround(){
    const h = 6*DPR;
    const y = H - h;
    ctx.fillStyle = 'rgba(255,255,255,.08)';
    ctx.fillRect(0, y, W, h);
    ctx.fillStyle = 'rgba(120,170,255,.28)';
    ctx.fillRect(0, y, W, 1*DPR);
  }

  function drawParticles(now){
    particles = particles.filter(p => (now - p.born) < p.life);
    for (const p of particles){
      const age = (now - p.born);
      const k = 1 - age / p.life;
      p.x += p.vx;
      p.y += p.vy;
      p.vy += 0.02*DPR; // gravity

      ctx.globalAlpha = 0.8 * k;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fillStyle = p.good ? 'rgba(140, 200, 255, 1)' : 'rgba(255, 170, 170, 1)';
      ctx.fill();
      ctx.globalAlpha = 1;
    }
  }

  function tick(now){
    if (!running || paused) return;

    const dt = Math.min(32, now - lastTime); // ms
    lastTime = now;

    // spawn
    lastSpawn += dt;
    const effectiveEvery = Math.max(140, spawnEvery - (level-1)*18); // level越高越密
    while (lastSpawn >= effectiveEvery){
      lastSpawn -= effectiveEvery;
      spawnOne();
      if (Math.random() < 0.12 + level*0.01) spawnOne(); // 偶尔双发
    }

    // update
    const fall = (dt / 16.67); // frame factor
    for (const d of drops){
      d.y += d.speed * fall * 6.2; // 调一调手感
    }

    // hit ground
    const groundY = H - 6*DPR;
    let missed = 0;
    drops = drops.filter(d => {
      if (d.y >= groundY){
        missed++;
        burst(d.x, groundY, 22*DPR, false);
        return false;
      }
      return true;
    });

    if (missed > 0){
      life -= missed;
      combo = 0;
      if (life <= 0){
        life = 0;
        syncHUD();
        render(now);
        gameOver();
        return;
      }
      syncHUD();
    }

    render(now);
    requestAnimationFrame(tick);
  }

  function render(now){
    drawBG(now);
    drawGround();
    drawDrops();
    drawParticles(now);

    // 小提示（暂停/未开始）
    if (!running && !over){
      ctx.globalAlpha = 0.8;
      ctx.fillStyle = 'rgba(255,255,255,.85)';
      ctx.font = `${14*DPR}px ui-sans-serif, system-ui`;
      ctx.textAlign = 'left';
      ctx.fillText('点击开始，或按 Space 暂停 / R 重开', 14*DPR, 22*DPR);
      ctx.globalAlpha = 1;
    }
  }

  // UI bindings
  startBtn.addEventListener('click', () => {
    // 恢复标题（如果上次 game over 改过）
    overlay.querySelector('h1').textContent = '打字雨 Typing Rain';
    overlay.querySelector('p').innerHTML =
      '字母会从天上掉下来，在落地前按下对应字母即可消除并得分。<br/>' +
      '<span class="warn">注意：</span>必须用英文键盘输入（A-Z），不区分大小写。';
    setLabels();
    if (!running) startGame();
  });
  pauseBtn.addEventListener('click', togglePause);
  resetBtn.addEventListener('click', () => { resetGame(); setLabels(); render(performance.now()); });

  // init
  resize();
  setLabels();
  resetGame();
  render(performance.now());
})();
</script>
</body>
</html>
