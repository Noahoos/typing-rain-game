<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ‰“å­—é›¨ Â· å¤šæ¨¡å¼ Typing Rain</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.10);
      --line:rgba(255,255,255,.12);
      --txt:#e8ecff;
      --muted:rgba(232,236,255,.75);
      --good:#2de38a;
      --bad:#ff4d6d;
      --warn:#ffd166;
      --shadow:0 20px 80px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Microsoft YaHei", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1200px 700px at 20% 10%, rgba(122,98,255,.25), transparent 60%),
              radial-gradient(1000px 600px at 80% 0%, rgba(45,227,138,.18), transparent 55%),
              radial-gradient(800px 500px at 70% 90%, rgba(255,209,102,.10), transparent 60%),
              var(--bg);
      color:var(--txt); font-family:var(--sans);
      overflow:hidden;
    }
    #wrap{height:100%; display:flex; flex-direction:column;}
    header{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
      backdrop-filter: blur(8px);
    }
    .left{display:flex; gap:10px; align-items:center; min-width:0;}
    .brand{
      display:flex; align-items:center; gap:10px; min-width:0;
      padding:8px 10px; border:1px solid var(--line); border-radius:999px;
      background:var(--panel);
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background:var(--good);
      box-shadow:0 0 0 6px rgba(45,227,138,.10);
      flex:0 0 auto;
    }
    .title{font-weight:800; letter-spacing:.4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .sub{font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .chips{display:flex; flex-wrap:wrap; gap:8px; align-items:center;}
    .chip{
      display:flex; align-items:center; gap:8px;
      padding:6px 10px; border:1px solid var(--line); border-radius:999px;
      background:var(--panel);
      font-size:12px; color:var(--muted);
    }
    .chip b{color:var(--txt)}
    .btn{
      cursor:pointer; user-select:none;
      padding:8px 12px; border-radius:12px;
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--txt);
      font-weight:700;
      transition: transform .08s ease, background .15s ease;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{background:var(--panel2)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color:rgba(45,227,138,.35);
      background:linear-gradient(180deg, rgba(45,227,138,.16), rgba(255,255,255,.06));
    }
    .btn.danger{
      border-color:rgba(255,77,109,.35);
      background:linear-gradient(180deg, rgba(255,77,109,.14), rgba(255,255,255,.06));
    }
    main{position:relative; flex:1; overflow:hidden;}
    canvas{width:100%; height:100%; display:block;}
    #hud{
      position:absolute; inset:auto 12px 12px 12px;
      display:flex; gap:10px; align-items:flex-end; justify-content:space-between;
      pointer-events:none;
    }
    .panel{
      pointer-events:auto;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      backdrop-filter: blur(10px);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:10px 12px;
    }
    .inputRow{display:flex; gap:8px; align-items:center;}
    .input{
      width:min(520px, 62vw);
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.20);
      color:var(--txt);
      outline:none;
      font-family:var(--mono);
      font-size:14px;
    }
    .hint{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.25}
    .kbd{
      font-family:var(--mono);
      font-size:12px;
      padding:2px 6px;
      border:1px solid rgba(255,255,255,.18);
      border-bottom-color: rgba(255,255,255,.28);
      border-radius:8px;
      background:rgba(255,255,255,.06);
      color:var(--txt);
    }
    #overlay{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.38);
      backdrop-filter: blur(10px);
      padding:18px;
    }
    .card{
      width:min(860px, 100%);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      box-shadow:var(--shadow);
      padding:16px;
    }
    .cardTop{display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap}
    .card h1{margin:0; font-size:22px; letter-spacing:.6px}
    .card p{margin:8px 0 0; color:var(--muted); line-height:1.5}
    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; margin-top:12px}
    @media (max-width:860px){ .grid{grid-template-columns:1fr;}}
    .box{
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      background:rgba(0,0,0,.18);
      padding:12px;
    }
    .box h3{margin:0 0 10px; font-size:14px; color:var(--muted); letter-spacing:.3px}
    .modes{display:flex; flex-wrap:wrap; gap:10px}
    .modeBtn{
      flex:1;
      min-width:210px;
      text-align:left;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
    }
    .modeBtn:hover{background:rgba(255,255,255,.09)}
    .modeBtn:active{transform: translateY(1px)}
    .modeName{font-weight:800}
    .modeDesc{margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    label{font-size:12px; color:var(--muted); display:flex; align-items:center; gap:8px}
    input[type="range"]{width:200px}
    .statline{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
    .pill{
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      font-size:12px; color:var(--muted);
    }
    .pill b{color:var(--txt)}
    .rightActions{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .tiny{font-size:12px; color:var(--muted)}
    .sep{height:1px; background:rgba(255,255,255,.10); margin:10px 0}
    .toast{
      position:absolute; top:14px; right:14px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      padding:10px 12px;
      box-shadow:var(--shadow);
      opacity:0; transform: translateY(-6px);
      transition: opacity .2s ease, transform .2s ease;
      pointer-events:none;
      max-width:min(420px, 92vw);
      color:var(--txt);
    }
    .toast.show{opacity:1; transform: translateY(0)}
    .toast .t{font-weight:800}
    .toast .d{margin-top:4px; font-size:12px; color:var(--muted); line-height:1.35}
  </style>
</head>
<body>
<div id="wrap">
  <header>
    <div class="left">
      <div class="brand">
        <span class="dot" id="statusDot"></span>
        <div style="min-width:0">
          <div class="title">æ‰“å­—é›¨ Â· å¤šç‰ˆæœ¬</div>
          <div class="sub" id="subTitle">æ”¯æŒï¼šè‹±æ–‡ / ä¸­æ–‡å•å­— / çƒ˜ç„™è¯åº“ï¼ˆå¯åˆ‡æ¢ï¼‰</div>
        </div>
      </div>
      <div class="chips">
        <div class="chip">æ¨¡å¼ï¼š<b id="modeLabel">æœªå¼€å§‹</b></div>
        <div class="chip">åˆ†æ•°ï¼š<b id="scoreLabel">0</b></div>
        <div class="chip">è¿å‡»ï¼š<b id="comboLabel">0</b></div>
        <div class="chip">ç”Ÿå‘½ï¼š<b id="lifeLabel">3</b></div>
      </div>
    </div>
    <div class="rightActions">
      <button class="btn" id="btnMode">é€‰æ‹©ç‰ˆæœ¬</button>
      <button class="btn" id="btnPause"><span>â¸</span>æš‚åœ</button>
      <button class="btn danger" id="btnReset"><span>â†»</span>é‡å¼€</button>
      <button class="btn primary" id="btnStart"><span>â–¶</span>å¼€å§‹</button>
    </div>
  </header>

  <main>
    <canvas id="cv"></canvas>

    <div id="hud">
      <div class="panel">
        <div class="inputRow">
          <input id="input" class="input" placeholder="åœ¨è¿™é‡Œè¾“å…¥ï¼šè‹±æ–‡ç›´æ¥æ‰“ï¼›ä¸­æ–‡ç”¨è¾“å…¥æ³•ï¼Œå›è½¦ç¡®è®¤" autocomplete="off" spellcheck="false" />
          <button class="btn primary" id="btnEnter">ç¡®è®¤</button>
        </div>
        <div class="hint" id="hint">
          å¿«æ·é”®ï¼š<span class="kbd">Space</span> æš‚åœ/ç»§ç»­ï¼Œ
          <span class="kbd">R</span> é‡å¼€ï¼Œ
          <span class="kbd">M</span> é€‰æ‹©ç‰ˆæœ¬ã€‚
          ä¸­æ–‡æ¨¡å¼ï¼šå»ºè®®è¾“å…¥åæŒ‰ <span class="kbd">Enter</span>ã€‚
        </div>
      </div>

      <div class="panel" style="min-width:240px">
        <div class="pill">å‘½ä¸­ï¼š<b id="hitLabel">0</b>ã€€æ¼æ‰ï¼š<b id="missLabel">0</b></div>
        <div class="pill" style="margin-top:8px">é€Ÿåº¦ï¼š<b id="spdLabel">1.0x</b>ã€€å¯†åº¦ï¼š<b id="densLabel">1.0x</b></div>
        <div class="pill" style="margin-top:8px">è¶£å‘³ï¼š<b id="funLabel">ğŸ¯ ç²¾å‡†å‘½ä¸­åŠ åˆ†</b></div>
      </div>
    </div>

    <div class="toast" id="toast">
      <div class="t" id="toastT">æç¤º</div>
      <div class="d" id="toastD">å†…å®¹</div>
    </div>

    <div id="overlay">
      <div class="card">
        <div class="cardTop">
          <div>
            <h1>é€‰æ‹©ä½ çš„ç‰ˆæœ¬ï¼šæ‰“å­—é›¨æ€ä¹ˆç©</h1>
            <p>
              ä½ å¯ä»¥éšæ—¶åˆ‡æ¢ç‰ˆæœ¬ï¼ˆ<span class="kbd">M</span>ï¼‰ï¼ŒåŒä¸€ä¸ªé¡µé¢é‡Œç©è‹±æ–‡ã€ä¸­æ–‡å•å­—æˆ–ã€Œçƒ˜ç„™ç”²æ–¹è¯åº“ã€ã€‚
              å‘½ä¸­ä¼šåŠ åˆ†ã€è¿å‡»ä¼šåŠ é€ŸåŠ åˆ†ï¼›æ¼æ‰ä¼šæ‰£ç”Ÿå‘½ã€‚
            </p>
          </div>
          <div class="rightActions">
            <span class="tiny">æç¤ºï¼šæƒ³æ›´åƒâ€œç”²æ–¹çƒ˜ç„™â€å°±é€‰ <b>çƒ˜ç„™è¯é›¨</b></span>
          </div>
        </div>

        <div class="grid">
          <div class="box">
            <h3>ç‰ˆæœ¬é€‰æ‹©</h3>
            <div class="modes">
              <button class="modeBtn" data-mode="EN_LETTERS">
                <div class="modeName">è‹±æ–‡ Â· å­—æ¯é›¨</div>
                <div class="modeDesc">æœ€ç»å…¸ï¼šAâ€“Z æ‰è½ã€‚é€‚åˆçƒ­èº«ã€ç»ƒååº”ã€‚</div>
              </button>

              <button class="modeBtn" data-mode="ZH_CHARS">
                <div class="modeName">ä¸­æ–‡ Â· å•å­—é›¨</div>
                <div class="modeDesc">éšæœºå¸¸ç”¨æ±‰å­—æ‰è½ã€‚é€‚åˆç»ƒâ€œä¸­æ–‡è¾“å…¥æ³•æ‰‹æ„Ÿâ€ã€‚</div>
              </button>

              <button class="modeBtn" data-mode="BAKERY_WORDS">
                <div class="modeName">çƒ˜ç„™ç”²æ–¹ Â· è¯é›¨ï¼ˆæ¨èï¼‰</div>
                <div class="modeDesc">äº§å“/åŸæ–™/é—¨åº—/è¿è¥è¯åº“ã€‚æ›´åƒå“ç‰Œç»ƒæ‰“å­—ï¼Œè¿˜æ›´æœ‰æ¢—ã€‚</div>
              </button>
            </div>

            <div class="sep"></div>

            <h3>éš¾åº¦ & è¶£å‘³è®¾ç½®</h3>
            <div class="row">
              <label>é€Ÿåº¦ <input id="rngSpeed" type="range" min="0.6" max="2.2" step="0.1" value="1.0" /></label>
              <label>å¯†åº¦ <input id="rngDensity" type="range" min="0.6" max="2.2" step="0.1" value="1.0" /></label>
              <label>ç”Ÿå‘½ <input id="rngLives" type="range" min="1" max="8" step="1" value="3" /></label>
            </div>

            <div class="statline">
              <div class="pill">è¿å‡»è¶Šé«˜ï¼šæ‰è½è¶Šå¿«ï¼Œå¾—åˆ†è¶Šå¤š</div>
              <div class="pill">å‘½ä¸­é•¿è¯ï¼šé¢å¤–å¥–åŠ±</div>
              <div class="pill">æ¼æ‰ï¼šæ‰£ç”Ÿå‘½ + æ¸…ç©ºè¿å‡»</div>
            </div>
          </div>

          <div class="box">
            <h3>æ“ä½œæç¤º</h3>
            <div class="pill"><b>è‹±æ–‡æ¨¡å¼ï¼š</b>ç›´æ¥æ‰“å­—æ¯ï¼Œè‡ªåŠ¨å‘½ä¸­</div>
            <div class="pill" style="margin-top:8px"><b>ä¸­æ–‡æ¨¡å¼ï¼š</b>ç”¨ä¸­æ–‡è¾“å…¥æ³•è¾“å…¥åæŒ‰ <b>Enter</b> æˆ–ç‚¹â€œç¡®è®¤â€</div>
            <div class="pill" style="margin-top:8px"><b>éšæ—¶åˆ‡æ¢ï¼š</b><span class="kbd">M</span> æˆ–é¡¶éƒ¨ã€Œé€‰æ‹©ç‰ˆæœ¬ã€</div>
            <div class="pill" style="margin-top:8px"><b>æš‚åœ/ç»§ç»­ï¼š</b><span class="kbd">Space</span></div>
            <div class="pill" style="margin-top:8px"><b>é‡å¼€ï¼š</b><span class="kbd">R</span></div>
            <div class="sep"></div>
            <button class="btn primary" id="btnGo">å¼€å§‹ï¼ˆç”¨å½“å‰é€‰æ‹©ï¼‰</button>
            <button class="btn" id="btnClose">å…ˆçœ‹çœ‹</button>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
(() => {
  // ---------- Utils ----------
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
  const rand=(a,b)=>a+Math.random()*(b-a);
  const pick=(arr)=>arr[(Math.random()*arr.length)|0];
  const now=()=>performance.now();

  // ---------- Word Banks ----------
  const EN_LETTERS = "ASDFGHJKLQWERTYUIOPZXCVBNM".split("");

  // å¸¸ç”¨æ±‰å­—ï¼ˆåå·¥ä½œ&ç”Ÿæ´»å¸¸è§ï¼‰
  const ZH_CHARS = (
    "è¶çƒ­é›†åˆçƒ˜ç„™é¢åŒ…å¯é¢‚åå¸è´æœå¥¶æ²¹é»„æ²¹å‘é…µå¼€é…¥çƒ¤ç®±é†’å‘æ…æ‹Œé¢å›¢èŠå£«è’œé¦™èœ‚èœœçˆ†æµ†" +
    "é—¨åº—æ’é˜Ÿä¸Šæ–°é¢„å”®æ ¸é”€å›¢è´­ç›´æ’­ç§è‰è¾¾äººç‚¹è¯„æŠ–éŸ³å°çº¢ä¹¦ä¼šå‘˜åˆ¸åŒ…å¤è´­è½¬åŒ–æ•°æ®é¢„ç®—" +
    "å“è´¨å‡ºå“æ ‡å‡†é«˜å³°æ‰¿æ¥åº“å­˜æ’äº§åŸæ–™é™ˆåˆ—çƒ­åº¦å£ç¢‘å·®è¯„ç”³è¯‰åˆè§„æ•ˆç‡å¢é•¿"
  ).split("");

  // ç”²æ–¹çƒ˜ç„™è¯åº“ï¼ˆä½ å¯ä»¥ç»§ç»­åŠ ï¼‰
  const BAKERY_WORDS = [
    // äº§å“/ç³»åˆ—ï¼ˆå¯æŒ‰ä½ å“ç‰Œ SKU è°ƒæ•´ï¼‰
    "é…¥çš®çƒ¤è‚ å·","å¢¨è¥¿å“¥è¾£æ¤’é…¥çš®çƒ¤è‚ å·","é»‘èƒ¡æ¤’é¦™è‚ é…¥çš®å·",
    "é”…å·´å¯é¢‚","æŠ¹èŒ¶é”…å·´å¯é¢‚","å¥¥åˆ©å¥¥é”…å·´å¯é¢‚",
    "çˆ†æµ†è’œé¦™èœ‚èœœåå¸","è¶çƒ­å¿ƒåŠ¨è›‹æŒ","å¼€å¿ƒæœè‰è“é©¬å¡é¾™","é©¬å¡é¾™",
    "è´æœ","å¯é¢‚","ä¸¹éº¦","åå¸","æ³•æ£","è´è¶é…¥","åšæœæ£’",
    // åŸæ–™/å·¥è‰º
    "é»„æ²¹","å¥¶æ²¹","é…µæ¯","å‘é…µ","é†’å‘","å¼€é…¥","å±‚æ¬¡","çƒ˜çƒ¤","å‡ºç‚‰","ç°çƒ¤","çˆ†æµ†",
    "æŠ¹èŒ¶","å¥¥åˆ©å¥¥","èŠå£«","è’œé¦™","èœ‚èœœ","å¼€å¿ƒæœ","è‰è“","é»‘èƒ¡æ¤’","è¾£æ¤’",
    // è¿è¥/ç”²æ–¹å¸¸ç”¨
    "é¢„å”®","ä¸Šæ–°","çˆ†å“","å¤§ç‰Œæ—¥","ä»£é‡‘åˆ¸","æ ¸é”€ç‡","è½¬åŒ–ç‡","å¤è´­ç‡","å®¢å•ä»·",
    "è¾¾äºº","ç§è‰","æ¢åº—","ç›´æ’­","æŠ•æµ","çŸ©é˜µ","é€‰é¢˜","è„šæœ¬","å°é¢","å®Œæ’­ç‡","äº’åŠ¨ç‡",
    "é—¨åº—æ‰¿æ¥","é«˜å³°æ‰¿æ¥","å‡ºå“æ ‡å‡†","åŸ¹è®­SOP","æ’äº§","å¤‡è´§","åº“å­˜","é™ˆåˆ—","å£ç¢‘",
    "å·®è¯„å›å¤","ç”³è¯‰","åˆè§„","æ•°æ®å¤ç›˜","ä¸€åŸä¸€æ–¹æ¡ˆ","å‘¨å‘¨æœ‰çˆ†å“"
  ];

  const MODES = {
    EN_LETTERS: { name:"è‹±æ–‡ Â· å­—æ¯é›¨", type:"letters", bank: EN_LETTERS },
    ZH_CHARS: { name:"ä¸­æ–‡ Â· å•å­—é›¨", type:"zh", bank: ZH_CHARS },
    BAKERY_WORDS: { name:"çƒ˜ç„™ç”²æ–¹ Â· è¯é›¨", type:"words", bank: BAKERY_WORDS }
  };

  // ---------- DOM ----------
  const cv = document.getElementById("cv");
  const ctx = cv.getContext("2d");
  const overlay = document.getElementById("overlay");
  const btnGo = document.getElementById("btnGo");
  const btnClose = document.getElementById("btnClose");
  const btnMode = document.getElementById("btnMode");
  const btnPause = document.getElementById("btnPause");
  const btnReset = document.getElementById("btnReset");
  const btnStart = document.getElementById("btnStart");
  const btnEnter = document.getElementById("btnEnter");
  const input = document.getElementById("input");

  const modeLabel = document.getElementById("modeLabel");
  const scoreLabel = document.getElementById("scoreLabel");
  const comboLabel = document.getElementById("comboLabel");
  const lifeLabel = document.getElementById("lifeLabel");
  const hitLabel = document.getElementById("hitLabel");
  const missLabel = document.getElementById("missLabel");
  const spdLabel = document.getElementById("spdLabel");
  const densLabel = document.getElementById("densLabel");
  const statusDot = document.getElementById("statusDot");
  const subTitle = document.getElementById("subTitle");

  const rngSpeed = document.getElementById("rngSpeed");
  const rngDensity = document.getElementById("rngDensity");
  const rngLives = document.getElementById("rngLives");

  const toast = document.getElementById("toast");
  const toastT = document.getElementById("toastT");
  const toastD = document.getElementById("toastD");

  const showToast = (t,d) => {
    toastT.textContent=t; toastD.textContent=d;
    toast.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t=setTimeout(()=>toast.classList.remove("show"), 1500);
  };

  // ---------- Canvas Resize ----------
  let W=0,H=0, DPR=1;
  function resize(){
    DPR = Math.min(2, window.devicePixelRatio || 1);
    W = cv.clientWidth; H = cv.clientHeight;
    cv.width = Math.floor(W*DPR);
    cv.height = Math.floor(H*DPR);
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }
  window.addEventListener("resize", resize);

  // ---------- Game State ----------
  let modeKey = "BAKERY_WORDS";
  let running = false;
  let paused = false;

  let speedMul = parseFloat(rngSpeed.value);
  let densityMul = parseFloat(rngDensity.value);
  let baseLives = parseInt(rngLives.value,10);

  let score=0, combo=0, lives=baseLives, hit=0, miss=0;
  let drops = [];
  let lastSpawn=0;
  let tPrev=now();

  // drop structure
  // {text, x, y, vy, size, w, h, glow, born, id}
  let dropId=1;

  function resetStats(){
    score=0; combo=0; lives=baseLives; hit=0; miss=0;
    drops.length=0;
    updateHUD();
  }

  function updateHUD(){
    modeLabel.textContent = MODES[modeKey].name;
    scoreLabel.textContent = String(score);
    comboLabel.textContent = String(combo);
    lifeLabel.textContent = String(lives);
    hitLabel.textContent = String(hit);
    missLabel.textContent = String(miss);
    spdLabel.textContent = speedMul.toFixed(1) + "x";
    densLabel.textContent = densityMul.toFixed(1) + "x";
    subTitle.textContent = (MODES[modeKey].type==="words")
      ? "çƒ˜ç„™ç”²æ–¹è¯åº“ï¼šäº§å“/åŸæ–™/è¿è¥ä¸€èµ·ä¸‹é›¨ â˜”ï¸"
      : (MODES[modeKey].type==="zh" ? "ä¸­æ–‡è¾“å…¥æ³•æ¨¡å¼ï¼šè¾“å…¥åæŒ‰å›è½¦æ›´ç¨³" : "è‹±æ–‡çƒ­èº«ï¼šæ‰‹é€Ÿèµ·é£");
    statusDot.style.background = running && !paused ? "var(--good)" : (paused ? "var(--warn)" : "var(--muted)");
    statusDot.style.boxShadow = running && !paused ? "0 0 0 6px rgba(45,227,138,.10)" :
                               (paused ? "0 0 0 6px rgba(255,209,102,.10)" : "0 0 0 6px rgba(232,236,255,.08)");
  }

  function setMode(key){
    modeKey = key;
    updateHUD();
    showToast("å·²åˆ‡æ¢ç‰ˆæœ¬", MODES[modeKey].name);
  }

  // ---------- Spawn & Measure ----------
  function measureText(text, size){
    ctx.font = `${size}px ${MODES[modeKey].type==="letters" ? "var(--mono)" : "var(--sans)"}`;
    const m = ctx.measureText(text);
    const w = m.width;
    const h = size;
    return {w,h};
  }

  function spawnOne(){
    const conf = MODES[modeKey];
    const text = pick(conf.bank);

    // è¯è¶Šé•¿ï¼Œå­—ä½“ç¨å¾®å°ä¸€ç‚¹ï¼Œé¿å…æŒ¤
    let size = conf.type==="words" ? clamp(26 - (String(text).length-2)*2, 16, 26) : 26;
    if(conf.type==="letters") size = 28;
    if(conf.type==="zh") size = 28;

    const {w,h} = measureText(text, size);
    const margin = 16;
    const x = rand(margin, Math.max(margin, W - w - margin));
    const y = -rand(20, 140);

    // é€Ÿåº¦ï¼šåŸºç¡€ + éš¾åº¦ + comboè½»å¾®åŠ é€Ÿ
    const base = 70 + (conf.type==="letters"? 10: 0);
    const vy = (base + rand(0, 60)) * speedMul * (1 + combo*0.02);

    drops.push({
      id: dropId++,
      text: String(text),
      x, y, vy,
      size,
      w, h,
      glow: rand(0.3, 0.8),
      born: now()
    });
  }

  function spawnLoop(t){
    // å¯†åº¦ï¼šéšæ—¶é—´ç•¥æå‡ + densityMul
    const conf = MODES[modeKey];
    const baseInterval = conf.type==="letters" ? 320 : (conf.type==="zh" ? 360 : 420);
    const interval = baseInterval / densityMul / (1 + Math.min(0.6, combo*0.03));
    if(t - lastSpawn > interval){
      lastSpawn = t;
      spawnOne();
    }
  }

  // ---------- Hit / Miss ----------
  function scoreFor(text){
    // è¯è¶Šé•¿å¥–åŠ±è¶Šé«˜
    const len = String(text).length;
    const base = 10;
    return base + Math.min(60, len*8) + Math.min(40, combo*2);
  }

  function tryHit(inputText){
    const raw = (inputText ?? "").trim();
    if(!raw) return false;

    // è‹±æ–‡å­—æ¯æ¨¡å¼ï¼šåªå–æœ€åä¸€ä¸ªå­—æ¯ä¹Ÿè¡Œ
    const conf = MODES[modeKey];
    let token = raw;

    if(conf.type==="letters"){
      token = raw.slice(-1).toUpperCase();
    }

    // æ‰¾åˆ°æœ€æ¥è¿‘åº•éƒ¨çš„åŒ¹é…ï¼ˆæ›´ç´§å¼ å¥½ç©ï¼‰
    let idx=-1;
    let bestY=-Infinity;
    for(let i=0;i<drops.length;i++){
      const d=drops[i];
      if(d.text === token){
        if(d.y > bestY){ bestY = d.y; idx=i; }
      }
    }

    if(idx>=0){
      const d = drops[idx];
      drops.splice(idx,1);

      hit++;
      combo++;
      const add = scoreFor(d.text);
      score += add;

      // å‘½ä¸­ç‰¹æ•ˆï¼štoast + è½»å¾®æŠ–åŠ¨
      showToast("å‘½ä¸­ +"+add, `ã€Œ${d.text}ã€è¿å‡» ${combo}`);

      updateHUD();
      return true;
    }

    return false;
  }

  function onMiss(){
    miss++;
    lives--;
    combo = 0;
    showToast("æ¼æ‰ -1 ç”Ÿå‘½", "è¿å‡»æ¸…ç©ºï¼Œç¨³ä½å†æ¥");
    if(lives<=0){
      running = false;
      paused = false;
      showOverlay(`æ¸¸æˆç»“æŸ Â· å¾—åˆ† ${score}`, `å‘½ä¸­ ${hit} / æ¼æ‰ ${miss}ã€‚è¦ä¸å†æ¥ä¸€æŠŠï¼Ÿ`);
    }
    updateHUD();
  }

  // ---------- Render ----------
  function drawBG(t){
    // subtle moving stars
    ctx.clearRect(0,0,W,H);
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,"rgba(0,0,0,.0)");
    g.addColorStop(1,"rgba(0,0,0,.22)");
    ctx.fillStyle=g;
    ctx.fillRect(0,0,W,H);

    // grid-ish shimmer
    ctx.save();
    ctx.globalAlpha=0.06;
    ctx.strokeStyle="#fff";
    ctx.lineWidth=1;
    const step=52;
    const off=(t*0.02)%step;
    for(let x= -step; x<W+step; x+=step){
      ctx.beginPath();
      ctx.moveTo(x+off,0);
      ctx.lineTo(x+off,H);
      ctx.stroke();
    }
    ctx.restore();
  }

  function drawDrop(d){
    const conf = MODES[modeKey];
    ctx.save();

    // glow shadow
    ctx.globalAlpha = 0.95;
    ctx.shadowColor = conf.type==="words" ? "rgba(45,227,138,.35)" :
                      conf.type==="zh" ? "rgba(122,98,255,.35)" :
                      "rgba(255,255,255,.25)";
    ctx.shadowBlur = 18 + d.glow*18;

    ctx.font = `${d.size}px ${conf.type==="letters" ? "var(--mono)" : "var(--sans)"}`;
    ctx.textBaseline="top";

    // color based on danger level (closer to bottom => warmer)
    const danger = clamp(d.y / (H*0.85), 0, 1);
    const r = Math.floor(232 + danger*20);
    const g = Math.floor(236 - danger*80);
    const b = Math.floor(255 - danger*60);
    ctx.fillStyle = `rgb(${r},${g},${b})`;

    ctx.fillText(d.text, d.x, d.y);

    // underline hint for long words
    if(conf.type==="words" && d.text.length>=4){
      ctx.globalAlpha=0.45;
      ctx.shadowBlur=0;
      ctx.strokeStyle="rgba(255,255,255,.28)";
      ctx.lineWidth=1;
      ctx.beginPath();
      ctx.moveTo(d.x, d.y + d.size + 2);
      ctx.lineTo(d.x + d.w, d.y + d.size + 2);
      ctx.stroke();
    }

    ctx.restore();
  }

  function render(t){
    const dt = (t - tPrev)/1000;
    tPrev = t;

    drawBG(t);

    if(running && !paused){
      spawnLoop(t);

      // update drops
      for(let i=drops.length-1;i>=0;i--){
        const d = drops[i];
        d.y += d.vy * dt;

        // miss line
        if(d.y > H - 36){
          drops.splice(i,1);
          onMiss();
          continue;
        }
      }
    }

    // draw drops
    for(const d of drops) drawDrop(d);

    // ground line
    ctx.save();
    ctx.globalAlpha=0.18;
    ctx.strokeStyle="#fff";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(0, H-28);
    ctx.lineTo(W, H-28);
    ctx.stroke();
    ctx.restore();

    requestAnimationFrame(render);
  }

  // ---------- Overlay helpers ----------
  function showOverlay(title, desc){
    overlay.style.display="flex";
    overlay.querySelector("h1").textContent = title;
    overlay.querySelector("p").textContent = desc;
  }
  function hideOverlay(){ overlay.style.display="none"; }

  // ---------- Controls ----------
  function startGame(){
    if(!running){
      resetStats();
      running = true;
      paused = false;
      hideOverlay();
      showToast("å¼€å±€ï¼", MODES[modeKey].name);
    }else{
      paused = false;
      hideOverlay();
    }
    updateHUD();
    input.focus();
  }

  function togglePause(){
    if(!running) return;
    paused = !paused;
    showToast(paused ? "æš‚åœ" : "ç»§ç»­", paused ? "å–å£æ°´å†æˆ˜" : "å†²ï¼");
    updateHUD();
  }

  function resetGame(){
    running=false; paused=false;
    drops.length=0;
    resetStats();
    showOverlay("é€‰æ‹©ä½ çš„ç‰ˆæœ¬ï¼šæ‰“å­—é›¨æ€ä¹ˆç©", "ä½ å¯ä»¥éšæ—¶åˆ‡æ¢ç‰ˆæœ¬ï¼ˆMï¼‰ã€‚å‘½ä¸­åŠ åˆ†ï¼Œæ¼æ‰æ‰£ç”Ÿå‘½ã€‚");
    updateHUD();
  }

  // Enter confirm
  function confirmInput(){
    if(!running || paused) return;
    const v = input.value;
    const ok = tryHit(v);
    if(ok){
      input.value = "";
    }else{
      // è‹±æ–‡æ¨¡å¼ï¼šå…è®¸ç»§ç»­ç´¯ç§¯ï¼Œä¸å¼ºåˆ¶æ¸…ç©º
      if(MODES[modeKey].type !== "letters"){
        showToast("æœªå‘½ä¸­", "å†å¯¹å‡†ä¸€æ¬¡ï¼ˆä¸­æ–‡å»ºè®®å›è½¦ç¡®è®¤ï¼‰");
      }
    }
  }

  // Auto-match on input for letters (æ›´çˆ½)
  input.addEventListener("input", () => {
    const conf = MODES[modeKey];
    if(!running || paused) return;
    if(conf.type==="letters"){
      const v = input.value;
      const ok = tryHit(v);
      if(ok) input.value="";
      else if(v.length>2) input.value = v.slice(-2);
    }
  });

  // IME composition guard
  let composing=false;
  input.addEventListener("compositionstart", ()=>composing=true);
  input.addEventListener("compositionend", ()=>composing=false);

  input.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      if(composing) return;
      e.preventDefault();
      confirmInput();
    }
  });

  btnEnter.addEventListener("click", confirmInput);

  // header buttons
  btnStart.addEventListener("click", startGame);
  btnPause.addEventListener("click", togglePause);
  btnReset.addEventListener("click", resetGame);

  btnMode.addEventListener("click", () => {
    overlay.style.display="flex";
  });

  // overlay buttons
  btnClose.addEventListener("click", hideOverlay);
  btnGo.addEventListener("click", startGame);

  document.querySelectorAll(".modeBtn").forEach(b=>{
    b.addEventListener("click", ()=>{
      setMode(b.dataset.mode);
    });
  });

  // sliders
  function syncSettings(){
    speedMul = parseFloat(rngSpeed.value);
    densityMul = parseFloat(rngDensity.value);
    baseLives = parseInt(rngLives.value,10);
    // å¦‚æœæœªå¼€å±€ï¼Œå®æ—¶åæ˜ ç”Ÿå‘½
    if(!running){
      lives = baseLives;
      updateHUD();
    }
    updateHUD();
  }
  rngSpeed.addEventListener("input", syncSettings);
  rngDensity.addEventListener("input", syncSettings);
  rngLives.addEventListener("input", syncSettings);

  // keyboard shortcuts
  window.addEventListener("keydown", (e)=>{
    if(e.key === " "){
      e.preventDefault();
      if(running) togglePause();
      else startGame();
    }else if(e.key.toLowerCase() === "r"){
      resetGame();
    }else if(e.key.toLowerCase() === "m"){
      overlay.style.display="flex";
    }
  });

  // init
  resize();
  setMode(modeKey);
  resetGame();
  requestAnimationFrame(render);
})();
</script>
</body>
</html>
