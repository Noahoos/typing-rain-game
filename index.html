<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>打字雨 · 甲方烘焙版 Typing Rain</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.10);
      --line:rgba(255,255,255,.12);
      --txt:#e8ecff;
      --muted:rgba(232,236,255,.75);
      --good:#2de38a;
      --bad:#ff4d6d;
      --warn:#ffd166;
      --event:#b388ff;
      --shadow:0 20px 80px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Microsoft YaHei", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(122,98,255,.25), transparent 60%),
        radial-gradient(1000px 600px at 80% 0%, rgba(45,227,138,.18), transparent 55%),
        radial-gradient(800px 500px at 70% 90%, rgba(255,209,102,.10), transparent 60%),
        var(--bg);
      color:var(--txt);
      font-family:var(--sans);
      overflow:hidden;
    }
    #wrap{height:100%; display:flex; flex-direction:column;}
    header{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
      backdrop-filter: blur(8px);
    }
    .left{display:flex; gap:10px; align-items:center; min-width:0;}
    .brand{
      display:flex; align-items:center; gap:10px; min-width:0;
      padding:8px 10px; border:1px solid var(--line); border-radius:999px;
      background:var(--panel);
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background:var(--good);
      box-shadow:0 0 0 6px rgba(45,227,138,.10);
      flex:0 0 auto;
    }
    .title{font-weight:800; letter-spacing:.4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .sub{font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .chips{display:flex; flex-wrap:wrap; gap:8px; align-items:center;}
    .chip{
      display:flex; align-items:center; gap:8px;
      padding:6px 10px; border:1px solid var(--line); border-radius:999px;
      background:var(--panel);
      font-size:12px; color:var(--muted);
    }
    .chip b{color:var(--txt)}
    .btn{
      cursor:pointer; user-select:none;
      padding:8px 12px; border-radius:12px;
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--txt);
      font-weight:700;
      transition: transform .08s ease, background .15s ease;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{background:var(--panel2)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color:rgba(45,227,138,.35);
      background:linear-gradient(180deg, rgba(45,227,138,.16), rgba(255,255,255,.06));
    }
    .btn.danger{
      border-color:rgba(255,77,109,.35);
      background:linear-gradient(180deg, rgba(255,77,109,.14), rgba(255,255,255,.06));
    }
    main{position:relative; flex:1; overflow:hidden;}
    canvas{width:100%; height:100%; display:block;}
    #hud{
      position:absolute; inset:auto 12px 12px 12px;
      display:flex; gap:10px; align-items:flex-end; justify-content:space-between;
      pointer-events:none;
    }
    .panel{
      pointer-events:auto;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      backdrop-filter: blur(10px);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:10px 12px;
    }
    .inputRow{display:flex; gap:8px; align-items:center;}
    .input{
      width:min(520px, 62vw);
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.20);
      color:var(--txt);
      outline:none;
      font-family:var(--mono);
      font-size:14px;
    }
    .hint{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.25}
    .kbd{
      font-family:var(--mono);
      font-size:12px;
      padding:2px 6px;
      border:1px solid rgba(255,255,255,.18);
      border-bottom-color: rgba(255,255,255,.28);
      border-radius:8px;
      background:rgba(255,255,255,.06);
      color:var(--txt);
    }
    #overlay{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.38);
      backdrop-filter: blur(10px);
      padding:18px;
    }
    .card{
      width:min(920px, 100%);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      box-shadow:var(--shadow);
      padding:16px;
    }
    .cardTop{display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap}
    .card h1{margin:0; font-size:22px; letter-spacing:.6px}
    .card p{margin:8px 0 0; color:var(--muted); line-height:1.5}
    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; margin-top:12px}
    @media (max-width:920px){ .grid{grid-template-columns:1fr;}}
    .box{
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      background:rgba(0,0,0,.18);
      padding:12px;
    }
    .box h3{margin:0 0 10px; font-size:14px; color:var(--muted); letter-spacing:.3px}
    .modes{display:flex; flex-wrap:wrap; gap:10px}
    .modeBtn{
      flex:1;
      min-width:220px;
      text-align:left;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
    }
    .modeBtn:hover{background:rgba(255,255,255,.09)}
    .modeBtn:active{transform: translateY(1px)}
    .modeName{font-weight:800}
    .modeDesc{margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    label{font-size:12px; color:var(--muted); display:flex; align-items:center; gap:8px}
    input[type="range"]{width:200px}
    .pill{
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      font-size:12px; color:var(--muted);
    }
    .pill b{color:var(--txt)}
    .sep{height:1px; background:rgba(255,255,255,.10); margin:10px 0}
    .rightActions{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .tiny{font-size:12px; color:var(--muted)}
    .toast{
      position:absolute; top:14px; right:14px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      padding:10px 12px;
      box-shadow:var(--shadow);
      opacity:0; transform: translateY(-6px);
      transition: opacity .2s ease, transform .2s ease;
      pointer-events:none;
      max-width:min(520px, 92vw);
      color:var(--txt);
    }
    .toast.show{opacity:1; transform: translateY(0)}
    .toast .t{font-weight:800}
    .toast .d{margin-top:4px; font-size:12px; color:var(--muted); line-height:1.35}
  </style>
</head>
<body>
<div id="wrap">
  <header>
    <div class="left">
      <div class="brand">
        <span class="dot" id="statusDot"></span>
        <div style="min-width:0">
          <div class="title">打字雨 · 甲方烘焙版</div>
          <div class="sub" id="subTitle">支持：英文 / 中文单字 / 烘焙词库（带甲方事件卡）</div>
        </div>
      </div>
      <div class="chips">
        <div class="chip">模式：<b id="modeLabel">未开始</b></div>
        <div class="chip">分数：<b id="scoreLabel">0</b></div>
        <div class="chip">连击：<b id="comboLabel">0</b></div>
        <div class="chip">生命：<b id="lifeLabel">3</b></div>
      </div>
    </div>
    <div class="rightActions">
      <button class="btn" id="btnMode">选择版本</button>
      <button class="btn" id="btnPause"><span>⏸</span>暂停</button>
      <button class="btn danger" id="btnReset"><span>↻</span>重开</button>
      <button class="btn primary" id="btnStart"><span>▶</span>开始</button>
    </div>
  </header>

  <main>
    <canvas id="cv"></canvas>

    <div id="hud">
      <div class="panel">
        <div class="inputRow">
          <input id="input" class="input" placeholder="输入：英文直接打；中文/词库用输入法，回车确认" autocomplete="off" spellcheck="false" />
          <button class="btn primary" id="btnEnter">确认</button>
        </div>
        <div class="hint" id="hint">
          快捷键：<span class="kbd">Space</span> 暂停/继续，
          <span class="kbd">M</span> 选择版本，
          <span class="kbd">R</span> 重开（需先按 <span class="kbd">Esc</span> 让输入框失焦）。
          中文模式：输入后按 <span class="kbd">Enter</span> 更稳。
        </div>
      </div>

      <div class="panel" style="min-width:260px">
        <div class="pill">命中：<b id="hitLabel">0</b>　漏掉：<b id="missLabel">0</b></div>
        <div class="pill" style="margin-top:8px">速度：<b id="spdLabel">1.0x</b>　密度：<b id="densLabel">1.0x</b></div>
        <div class="pill" style="margin-top:8px">彩蛋：<b id="eventLabel">甲方事件卡 ON</b></div>
      </div>
    </div>

    <div class="toast" id="toast">
      <div class="t" id="toastT">提示</div>
      <div class="d" id="toastD">内容</div>
    </div>

    <div id="overlay">
      <div class="card">
        <div class="cardTop">
          <div>
            <h1>选择你的版本：打字雨怎么玩</h1>
            <p>
              你可以随时切换版本（<span class="kbd">M</span>）。
              烘焙词雨里会随机掉「甲方事件卡」：打中爆加分/回血，漏掉会更痛。
            </p>
          </div>
          <div class="rightActions">
            <span class="tiny">英文模式不抢快捷键：输入框内打 R 不会重开 ✅</span>
          </div>
        </div>

        <div class="grid">
          <div class="box">
            <h3>版本选择</h3>
            <div class="modes">
              <button class="modeBtn" data-mode="EN_LETTERS">
                <div class="modeName">英文 · 字母雨</div>
                <div class="modeDesc">A–Z 掉落。专注手速与反应（已修复 R 冲突）。</div>
              </button>
              <button class="modeBtn" data-mode="ZH_CHARS">
                <div class="modeName">中文 · 单字雨</div>
                <div class="modeDesc">常用汉字随机掉落。练中文输入法手感。</div>
              </button>
              <button class="modeBtn" data-mode="BAKERY_WORDS">
                <div class="modeName">烘焙甲方 · 词雨（推荐）</div>
                <div class="modeDesc">产品/原料/运营词库 + 甲方事件卡，更像真实工作现场。</div>
              </button>
            </div>

            <div class="sep"></div>

            <h3>难度设置</h3>
            <div class="row">
              <label>速度 <input id="rngSpeed" type="range" min="0.6" max="2.2" step="0.1" value="1.0" /></label>
              <label>密度 <input id="rngDensity" type="range" min="0.6" max="2.2" step="0.1" value="1.0" /></label>
              <label>生命 <input id="rngLives" type="range" min="1" max="8" step="1" value="3" /></label>
            </div>

            <div class="row" style="margin-top:10px">
              <label><input id="chkEvents" type="checkbox" checked /> 启用甲方事件卡（仅烘焙词雨）</label>
            </div>

            <div class="sep"></div>
            <div class="pill">连击越高：掉落越快、得分越多</div>
            <div class="pill" style="margin-top:8px">长词命中：额外奖励</div>
            <div class="pill" style="margin-top:8px">漏掉：扣生命 + 清空连击</div>
          </div>

          <div class="box">
            <h3>操作提示</h3>
            <div class="pill"><b>英文：</b>直接打字母，自动命中</div>
            <div class="pill" style="margin-top:8px"><b>中文/词库：</b>输入后按 <b>Enter</b> 或点“确认”</div>
            <div class="pill" style="margin-top:8px"><b>避免快捷键冲突：</b>输入框内不会触发 R/M；按 <b>Esc</b> 退出输入框</div>
            <div class="sep"></div>
            <button class="btn primary" id="btnGo">开始（用当前选择）</button>
            <button class="btn" id="btnClose">先看看</button>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
(() => {
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
  const rand=(a,b)=>a+Math.random()*(b-a);
  const pick=(arr)=>arr[(Math.random()*arr.length)|0];
  const now=()=>performance.now();

  // --- Banks ---
  const EN_LETTERS = "ASDFGHJKLQWERTYUIOPZXCVBNM".split("");
  const ZH_CHARS = (
    "烘焙面包可颂吐司贝果奶油黄油发酵开酥烤箱醒发搅拌面团芝士蒜香蜂蜜爆浆" +
    "门店排队上新预售核销团购直播种草达人点评抖音小红书会员券包复购转化数据预算" +
    "品质出品标准高峰承接库存排产原料陈列热度口碑差评申诉合规效率增长"
  ).split("");

  // 更像甲方：把词库分层更“工作现场”
  const BAKERY_WORDS = [
    // SKU/产品
    "酥皮烤肠卷","墨西哥辣椒酥皮烤肠卷","黑胡椒香肠酥皮卷",
    "锅巴可颂","抹茶锅巴可颂","奥利奥锅巴可颂",
    "爆浆蒜香蜂蜜吐司","趁热心动蛋挞","开心果草莓马卡龙",
    "贝果","可颂","丹麦","吐司","法棍","蝴蝶酥","坚果棒",
    // 工艺/供应链
    "开酥","醒发","发酵","烘烤","出炉","现烤","爆浆","层次","出品标准",
    "排产","备货","库存","原料","损耗","高峰承接","培训SOP",
    // 运营/内容/投放
    "预售","上新","爆品","大牌日","代金券","核销率","转化率","复购率","客单价",
    "达人矩阵","种草","探店","直播","投流","封面","脚本","完播率","互动率",
    "口碑","差评回复","申诉","合规","数据复盘","一城一方案","周周有爆品"
  ];

  // 甲方事件卡：更“真实办公室”
  const EVENT_CARDS = [
    { text:"平台审核收紧", onHit:{score:160, life:+1}, onMiss:{life:-1}, tip:"合规！材料！快！" },
    { text:"领导要复盘",   onHit:{score:180, life:0},  onMiss:{life:-1}, tip:"3分钟讲清楚：目标-动作-结果" },
    { text:"差评来了",     onHit:{score:150, life:+1}, onMiss:{life:-1}, tip:"先安抚，再补偿，再跟进" },
    { text:"爆单了",       onHit:{score:200, life:0},  onMiss:{life:-1}, tip:"承接！出品！排产！" },
    { text:"排产爆了",     onHit:{score:170, life:+1}, onMiss:{life:-1}, tip:"供应链&门店同步，别断货" },
    { text:"券核销异常",   onHit:{score:160, life:0},  onMiss:{life:-1}, tip:"先止损：下线/申诉/公告" }
  ];

  const MODES = {
    EN_LETTERS: { name:"英文 · 字母雨", type:"letters", bank: EN_LETTERS },
    ZH_CHARS: { name:"中文 · 单字雨", type:"zh", bank: ZH_CHARS },
    BAKERY_WORDS: { name:"烘焙甲方 · 词雨", type:"words", bank: BAKERY_WORDS }
  };

  // --- DOM ---
  const cv = document.getElementById("cv");
  const ctx = cv.getContext("2d");
  const overlay = document.getElementById("overlay");
  const btnGo = document.getElementById("btnGo");
  const btnClose = document.getElementById("btnClose");
  const btnMode = document.getElementById("btnMode");
  const btnPause = document.getElementById("btnPause");
  const btnReset = document.getElementById("btnReset");
  const btnStart = document.getElementById("btnStart");
  const btnEnter = document.getElementById("btnEnter");
  const input = document.getElementById("input");

  const modeLabel = document.getElementById("modeLabel");
  const scoreLabel = document.getElementById("scoreLabel");
  const comboLabel = document.getElementById("comboLabel");
  const lifeLabel = document.getElementById("lifeLabel");
  const hitLabel = document.getElementById("hitLabel");
  const missLabel = document.getElementById("missLabel");
  const spdLabel = document.getElementById("spdLabel");
  const densLabel = document.getElementById("densLabel");
  const statusDot = document.getElementById("statusDot");
  const subTitle = document.getElementById("subTitle");
  const eventLabel = document.getElementById("eventLabel");

  const rngSpeed = document.getElementById("rngSpeed");
  const rngDensity = document.getElementById("rngDensity");
  const rngLives = document.getElementById("rngLives");
  const chkEvents = document.getElementById("chkEvents");

  const toast = document.getElementById("toast");
  const toastT = document.getElementById("toastT");
  const toastD = document.getElementById("toastD");
  const showToast = (t,d) => {
    toastT.textContent=t; toastD.textContent=d;
    toast.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t=setTimeout(()=>toast.classList.remove("show"), 1600);
  };

  // --- Canvas ---
  let W=0,H=0, DPR=1;
  function resize(){
    DPR = Math.min(2, window.devicePixelRatio || 1);
    W = cv.clientWidth; H = cv.clientHeight;
    cv.width = Math.floor(W*DPR);
    cv.height = Math.floor(H*DPR);
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }
  window.addEventListener("resize", resize);

  // --- State ---
  let modeKey = "BAKERY_WORDS";
  let running=false, paused=false;

  let speedMul = parseFloat(rngSpeed.value);
  let densityMul = parseFloat(rngDensity.value);
  let baseLives = parseInt(rngLives.value,10);

  let score=0, combo=0, lives=baseLives, hit=0, miss=0;
  let drops=[];
  let lastSpawn=0;
  let tPrev=now();
  let dropId=1;
  let composing=false;

  function updateHUD(){
    modeLabel.textContent = MODES[modeKey].name;
    scoreLabel.textContent = String(score);
    comboLabel.textContent = String(combo);
    lifeLabel.textContent = String(lives);
    hitLabel.textContent = String(hit);
    missLabel.textContent = String(miss);
    spdLabel.textContent = speedMul.toFixed(1) + "x";
    densLabel.textContent = densityMul.toFixed(1) + "x";

    const eventsOn = chkEvents.checked && MODES[modeKey].type==="words";
    eventLabel.textContent = eventsOn ? "甲方事件卡 ON" : "甲方事件卡 OFF";

    subTitle.textContent = (MODES[modeKey].type==="words")
      ? "烘焙甲方词库：SKU/工艺/运营一起下雨 ☔️（含事件卡）"
      : (MODES[modeKey].type==="zh" ? "中文输入法：输入后回车确认" : "英文热身：输入框内打 R 不会触发重开 ✅");

    statusDot.style.background = running && !paused ? "var(--good)" : (paused ? "var(--warn)" : "rgba(232,236,255,.75)");
    statusDot.style.boxShadow = running && !paused ? "0 0 0 6px rgba(45,227,138,.10)" :
                               (paused ? "0 0 0 6px rgba(255,209,102,.10)" : "0 0 0 6px rgba(232,236,255,.08)");
  }

  function setMode(key){
    modeKey = key;
    updateHUD();
    showToast("已切换版本", MODES[modeKey].name);
  }

  function resetStats(){
    score=0; combo=0; lives=baseLives; hit=0; miss=0;
    drops.length=0;
    updateHUD();
  }

  // --- Measure / Spawn ---
  function measure(text,size){
    ctx.font = `${size}px ${MODES[modeKey].type==="letters" ? "var(--mono)" : "var(--sans)"}`;
    const m = ctx.measureText(text);
    return { w:m.width, h:size };
  }

  function spawnNormal(){
    const conf = MODES[modeKey];
    const text = pick(conf.bank);

    let size = conf.type==="words" ? clamp(26 - (String(text).length-2)*2, 16, 26) : 28;
    if(conf.type==="letters") size = 30;

    const {w,h} = measure(String(text), size);
    const margin=16;
    const x = rand(margin, Math.max(margin, W - w - margin));
    const y = -rand(20, 160);
    const base = 70 + (conf.type==="letters"? 10: 0);
    const vy = (base + rand(0, 70)) * speedMul * (1 + combo*0.02);

    drops.push({ id:dropId++, kind:"normal", text:String(text), x,y,vy,size,w,h, born:now() });
  }

  function spawnEvent(){
    const card = pick(EVENT_CARDS);
    const text = card.text;
    const size = 24;
    const {w,h} = measure(text, size);
    const margin=16;
    const x = rand(margin, Math.max(margin, W - w - margin));
    const y = -rand(40, 220);
    const vy = (80 + rand(0,60)) * speedMul * 1.05;

    drops.push({
      id:dropId++,
      kind:"event",
      text,
      event:card,
      x,y,vy,size,w,h,
      born:now()
    });
  }

  function spawnLoop(t){
    const conf = MODES[modeKey];
    const baseInterval = conf.type==="letters" ? 320 : (conf.type==="zh" ? 360 : 420);
    const interval = baseInterval / densityMul / (1 + Math.min(0.7, combo*0.03));
    if(t - lastSpawn > interval){
      lastSpawn = t;

      const eventsOn = chkEvents.checked && conf.type==="words";
      // 事件卡：小概率出现，越连击越容易触发
      const p = eventsOn ? (0.07 + Math.min(0.08, combo*0.005)) : 0;
      if(eventsOn && Math.random() < p) spawnEvent();
      else spawnNormal();
    }
  }

  // --- Scoring ---
  function scoreFor(text){
    const len = String(text).length;
    return 10 + Math.min(70, len*8) + Math.min(50, combo*2);
  }

  function applyEventHit(card){
    score += card.onHit.score;
    if(card.onHit.life){
      lives = clamp(lives + card.onHit.life, 0, 12);
    }
    combo += 2;
    showToast("事件卡命中！+"+card.onHit.score, card.tip + (card.onHit.life? "（+1生命）":""));
  }

  function applyEventMiss(card){
    lives += card.onMiss.life; // negative
    combo = 0;
    showToast("事件卡漏掉！", card.tip + "（更痛）");
  }

  function tryHit(inputText){
    const raw = (inputText ?? "").trim();
    if(!raw) return false;

    const conf = MODES[modeKey];
    let token = raw;

    if(conf.type==="letters"){
      token = raw.slice(-1).toUpperCase();
    }

    // 优先命中更靠近底部的同名项（更刺激）
    let idx=-1, bestY=-Infinity;
    for(let i=0;i<drops.length;i++){
      const d=drops[i];
      if(d.text === token){
        if(d.y > bestY){ bestY = d.y; idx=i; }
      }
    }

    if(idx>=0){
      const d=drops[idx];
      drops.splice(idx,1);

      hit++;

      if(d.kind==="event"){
        applyEventHit(d.event);
        updateHUD();
        return true;
      }

      combo++;
      const add = scoreFor(d.text);
      score += add;
      showToast("命中 +"+add, `「${d.text}」连击 ${combo}`);
      updateHUD();
      return true;
    }

    return false;
  }

  function onMiss(d){
    miss++;
    if(d && d.kind==="event"){
      applyEventMiss(d.event);
    }else{
      lives--;
      combo=0;
      showToast("漏掉 -1 生命", "连击清空，稳住再来");
    }

    if(lives<=0){
      running=false; paused=false;
      overlay.style.display="flex";
      overlay.querySelector("h1").textContent = `游戏结束 · 得分 ${score}`;
      overlay.querySelector("p").textContent = `命中 ${hit} / 漏掉 ${miss}。要不再来一把？`;
    }

    updateHUD();
  }

  // --- Render ---
  function drawBG(t){
    ctx.clearRect(0,0,W,H);
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,"rgba(0,0,0,.0)");
    g.addColorStop(1,"rgba(0,0,0,.22)");
    ctx.fillStyle=g;
    ctx.fillRect(0,0,W,H);

    ctx.save();
    ctx.globalAlpha=0.06;
    ctx.strokeStyle="#fff";
    ctx.lineWidth=1;
    const step=52;
    const off=(t*0.02)%step;
    for(let x=-step;x<W+step;x+=step){
      ctx.beginPath();
      ctx.moveTo(x+off,0);
      ctx.lineTo(x+off,H);
      ctx.stroke();
    }
    ctx.restore();
  }

  function drawDrop(d){
    const conf = MODES[modeKey];
    ctx.save();

    const danger = clamp(d.y / (H*0.85), 0, 1);
    ctx.font = `${d.size}px ${conf.type==="letters" ? "var(--mono)" : "var(--sans)"}`;
    ctx.textBaseline="top";

    if(d.kind==="event"){
      ctx.shadowColor = "rgba(179,136,255,.55)";
      ctx.shadowBlur = 22;
      ctx.globalAlpha = 0.98;
      ctx.fillStyle = `rgba(179,136,255,${0.92 - danger*0.25})`;
      ctx.fillText("⚡ "+d.text, d.x, d.y);
      // 小标线
      ctx.shadowBlur=0;
      ctx.globalAlpha=0.30;
      ctx.strokeStyle="rgba(179,136,255,.55)";
      ctx.lineWidth=2;
      ctx.beginPath();
      ctx.moveTo(d.x, d.y + d.size + 3);
      ctx.lineTo(d.x + d.w + 18, d.y + d.size + 3);
      ctx.stroke();
      ctx.restore();
      return;
    }

    ctx.shadowColor = conf.type==="words" ? "rgba(45,227,138,.35)" :
                      conf.type==="zh" ? "rgba(122,98,255,.35)" :
                      "rgba(255,255,255,.25)";
    ctx.shadowBlur = 16;

    const r = Math.floor(232 + danger*20);
    const gg = Math.floor(236 - danger*80);
    const b = Math.floor(255 - danger*60);
    ctx.fillStyle = `rgb(${r},${gg},${b})`;
    ctx.globalAlpha = 0.95;
    ctx.fillText(d.text, d.x, d.y);

    if(conf.type==="words" && d.text.length>=4){
      ctx.globalAlpha=0.35;
      ctx.shadowBlur=0;
      ctx.strokeStyle="rgba(255,255,255,.28)";
      ctx.lineWidth=1;
      ctx.beginPath();
      ctx.moveTo(d.x, d.y + d.size + 2);
      ctx.lineTo(d.x + d.w, d.y + d.size + 2);
      ctx.stroke();
    }

    ctx.restore();
  }

  function render(t){
    const dt = (t - tPrev)/1000;
    tPrev = t;

    drawBG(t);

    if(running && !paused){
      spawnLoop(t);

      for(let i=drops.length-1;i>=0;i--){
        const d = drops[i];
        d.y += d.vy * dt;

        if(d.y > H - 36){
          drops.splice(i,1);
          onMiss(d);
        }
      }
    }

    for(const d of drops) drawDrop(d);

    ctx.save();
    ctx.globalAlpha=0.18;
    ctx.strokeStyle="#fff";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(0, H-28);
    ctx.lineTo(W, H-28);
    ctx.stroke();
    ctx.restore();

    requestAnimationFrame(render);
  }

  // --- Controls ---
  function startGame(){
    if(!running){
      resetStats();
      running=true; paused=false;
      overlay.style.display="none";
      showToast("开局！", MODES[modeKey].name);
    }else{
      paused=false;
      overlay.style.display="none";
    }
    updateHUD();
    input.focus();
  }

  function togglePause(){
    if(!running) return;
    paused = !paused;
    showToast(paused ? "暂停" : "继续", paused ? "喝口水再战" : "冲！");
    updateHUD();
  }

  function resetGame(){
    running=false; paused=false;
    drops.length=0;
    resetStats();
    overlay.style.display="flex";
    overlay.querySelector("h1").textContent = "选择你的版本：打字雨怎么玩";
    overlay.querySelector("p").textContent = "烘焙词雨会随机掉甲方事件卡：打中爆加分/回血，漏掉更痛。";
    updateHUD();
  }

  function confirmInput(){
    if(!running || paused) return;
    const ok = tryHit(input.value);
    if(ok) input.value="";
    else if(MODES[modeKey].type!=="letters") showToast("未命中", "再对准一次（中文建议回车确认）");
  }

  // IME guard
  input.addEventListener("compositionstart", ()=>composing=true);
  input.addEventListener("compositionend", ()=>composing=false);

  input.addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){
      if(composing) return;
      e.preventDefault();
      confirmInput();
    }else if(e.key==="Escape"){
      input.blur();
      showToast("已退出输入框", "现在 R/M 快捷键可用");
    }
  });

  // letters auto-hit
  input.addEventListener("input", ()=>{
    if(!running || paused) return;
    if(MODES[modeKey].type==="letters"){
      const ok = tryHit(input.value);
      if(ok) input.value="";
      else if(input.value.length>2) input.value = input.value.slice(-2);
    }
  });

  btnEnter.addEventListener("click", confirmInput);
  btnStart.addEventListener("click", startGame);
  btnPause.addEventListener("click", togglePause);
  btnReset.addEventListener("click", resetGame);
  btnMode.addEventListener("click", ()=>overlay.style.display="flex");
  btnClose.addEventListener("click", ()=>overlay.style.display="none");
  btnGo.addEventListener("click", startGame);

  document.querySelectorAll(".modeBtn").forEach(b=>{
    b.addEventListener("click", ()=>setMode(b.dataset.mode));
  });

  function syncSettings(){
    speedMul = parseFloat(rngSpeed.value);
    densityMul = parseFloat(rngDensity.value);
    baseLives = parseInt(rngLives.value,10);
    if(!running){ lives = baseLives; updateHUD(); }
    updateHUD();
  }
  rngSpeed.addEventListener("input", syncSettings);
  rngDensity.addEventListener("input", syncSettings);
  rngLives.addEventListener("input", syncSettings);
  chkEvents.addEventListener("change", updateHUD);

  // ✅ 修复重点：当光标在输入框时，不触发全局快捷键（避免 R 冲突）
  window.addEventListener("keydown", (e)=>{
    const typing = (document.activeElement === input) || composing;

    if(typing){
      // 输入时不抢任何快捷键（避免 R/M 冲突）
      // Space 也不抢，避免误触；需要暂停请点按钮或先 Esc
      return;
    }

    if(e.key===" "){
      e.preventDefault();
      if(running) togglePause();
      else startGame();
    }else if(e.key.toLowerCase()==="r"){
      resetGame();
    }else if(e.key.toLowerCase()==="m"){
      overlay.style.display="flex";
    }
  });

  // init
  resize();
  setMode(modeKey);
  resetGame();
  requestAnimationFrame(render);
})();
</script>
</body>
</html>
